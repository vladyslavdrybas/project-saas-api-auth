version: "3.9"

services:
  php:
    container_name: ${PROJECT_NAME:-solo}-${SERVICE_NAME:-service}-api-${API_VERSION:-1.0}-php
    image: vd_php_base:1.0
    build:
        args:
          APP_ENV: ${APP_ENV}
    env_file:
      - .env
      - .env.local
    networks:
      - database_network
      - default
    depends_on:
      - database
    labels:
      - "traefik.enable=false"
    volumes:
      - ./app:/app:rw

  web:
    container_name: ${PROJECT_NAME:-solo}-${SERVICE_NAME:-service}-api-${API_VERSION:-1.0}-web
    image: vd_nginx_base:1.0
    build:
      args:
        APP_ENV: ${APP_ENV}
    env_file:
      - .env
      - .env.local
    networks:
      proxy_network:
        aliases:
          - ${APP_NAME}
      default:
        aliases:
          - ${APP_NAME}
    depends_on:
      - php
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${PROJECT_NAME}-${SERVICE_NAME}-http.rule=Host(`${HOST}`) && PathPrefix(`/${SERVICE_NAME}/api/v${API_VERSION}`, `/${SERVICE_NAME}/_profiler`)"
      - "traefik.http.routers.${PROJECT_NAME}-${SERVICE_NAME}-https.rule=Host(`${HOST}`) && PathPrefix(`/${SERVICE_NAME}/api/v${API_VERSION}`, `/${SERVICE_NAME}/_profiler`)"
      - "traefik.http.routers.${PROJECT_NAME}-${SERVICE_NAME}-https.tls.domains[0].main=${HOST}"
      - "traefik.http.routers.${PROJECT_NAME}-${SERVICE_NAME}-http.entrypoints=web"
      - "traefik.http.middlewares.${PROJECT_NAME}-${SERVICE_NAME}-https.redirectscheme.scheme=https"
      - "traefik.http.routers.${PROJECT_NAME}-${SERVICE_NAME}-https.entrypoints=websecure"
      - "traefik.http.routers.${PROJECT_NAME}-${SERVICE_NAME}-https.tls=true"
      - "traefik.http.routers.${PROJECT_NAME}-${SERVICE_NAME}-http.middlewares=${PROJECT_NAME}-${SERVICE_NAME}-https"
      - "traefik.http.middlewares.${PROJECT_NAME}-${SERVICE_NAME}-apiprefix.stripprefixregex.regex=/${SERVICE_NAME}/(?:api|proxy|dashboard|panel)/v[0-9]+(?:\\.[0-9]+)?/"
      - "traefik.http.routers.${PROJECT_NAME}-${SERVICE_NAME}-https.middlewares=${PROJECT_NAME}-${SERVICE_NAME}-apiprefix"
    volumes:
      - ./app/public:/app/public
      - ./tmp/log/nginx/:/var/log/nginx

volumes:
###> doctrine/doctrine-bundle ###
  database_data:
    name: ${PROJECT_NAME}_${SERVICE_NAME}_database_data
###< doctrine/doctrine-bundle ###

networks:
  proxy_network:
    name: ${PROXY_NETWORK}
    external: true
  database_network:
    name: ${DATABASE_NETWORK}
    external: true
  default:
    name: ${APP_NETWORK}
    external: false
